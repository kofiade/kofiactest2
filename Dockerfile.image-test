name: "CrowdStrike FCS Image Assessment"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  fcs-image-scan:
    name: "FCS Image Security Scan"
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write
      actions: read

    steps:

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker Image
        run: |
          docker build -t fcs-test-image:latest -f Dockerfile.image-test .

      - name: Run FCS Image Assessment
        id: fcs
        uses: crowdstrike/fcs-action@v3.0.0
        with:
          falcon_client_id: ${{ vars.FALCON_CLIENT_ID }}
          falcon_region: ${{ vars.FALCON_REGION }}
          scan_type: image
          image: 'fcs-test-image:latest'
          minimum_severity: high
          report_formats: 'json'
          output_path: './image-scan-results.json'
          upload_results: true
        env:
          FALCON_CLIENT_SECRET: ${{ secrets.FALCON_CLIENT_SECRET }}

      - name: Debug Exit Code
        if: always()
        run: |
          echo "==========================================="
          echo "  FCS CLI Exit Code: ${{ steps.fcs.outputs.exit-code }}"
          echo "==========================================="
          if [ -f "./image-scan-results.json" ]; then
            echo "=== JSON report preview ==="
            head -100 ./image-scan-results.json
          fi

      - name: Upload scan results as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fcs-image-scan-results
          path: ./image-scan-results.*
          if-no-files-found: warn

      - name: Run FCS Image Scan (SARIF)
        id: fcs-sarif
        if: always() && steps.fcs.outputs.exit-code != 0
        uses: crowdstrike/fcs-action@v3.0.0
        with:
          falcon_client_id: ${{ vars.FALCON_CLIENT_ID }}
          falcon_region: ${{ vars.FALCON_REGION }}
          scan_type: image
          image: 'fcs-test-image:latest'
          minimum_severity: high
          report_formats: 'sarif'
          output_path: './image-scan-results.sarif'
        env:
          FALCON_CLIENT_SECRET: ${{ secrets.FALCON_CLIENT_SECRET }}

      - name: Upload SARIF to GitHub Code Scanning
        if: always() && steps.fcs.outputs.exit-code != 0
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ./image-scan-results.sarif

      - name: "Enforce Policy: critical=1, high=1"
        if: always()
        run: |
          EXIT_CODE="${{ steps.fcs.outputs.exit-code }}"

          echo "==========================================="
          echo "  FCS Image Assessment ‚Äî Policy Check"
          echo "==========================================="
          echo "  FCS CLI Exit Code : ${EXIT_CODE}"
          echo "  Policy            : Fail on ‚â•1 critical OR ‚â•1 high"
          echo "  Image Scanned     : fcs-test-image:latest"
          echo "==========================================="

          if [ -z "${EXIT_CODE}" ]; then
            echo ""
            echo "‚ö†Ô∏è  EXIT CODE IS EMPTY"
            echo "   The FCS action did not produce an exit-code output."
            echo "   Check the 'Run FCS Image Assessment' step logs."
            echo ""
            echo "‚ùå FAILING WORKFLOW ‚Äî unable to verify image safety."
            exit 1
          fi

          if [ "${EXIT_CODE}" != "0" ]; then
            echo ""
            echo "üî¥ VULNERABILITIES DETECTED"
            echo "   The image contains ‚â•1 critical or ‚â•1 high CVEs."
            echo ""
            echo "   Next steps:"
            echo "   1. Check the Security tab for detailed findings"
            echo "   2. Download the 'fcs-image-scan-results' artifact"
            echo "   3. Review in the Falcon Console"
            echo ""
            echo "‚ùå IMAGE SCAN FAILED ‚Äî Merge blocked."
            exit 1
          else
            echo ""
            echo "üü¢ NO HIGH/CRITICAL VULNERABILITIES FOUND"
            echo ""
            echo "‚úÖ IMAGE SCAN PASSED ‚Äî Safe to proceed."
          fi
