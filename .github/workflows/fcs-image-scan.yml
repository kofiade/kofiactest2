# =====================================================
# CrowdStrike FCS ‚Äî Container Image Assessment
# =====================================================
# Scans container images for vulnerabilities (CVEs),
# malware, and can generate SBOM reports.
#
# Policy: Fail when ‚â•1 critical OR ‚â•1 high vulnerability found
# =====================================================

name: "CrowdStrike FCS Image Assessment"

# ----- WHEN DOES THIS RUN? -----
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  fcs-image-scan:
    name: "FCS Image Security Scan"
    runs-on: ubuntu-latest

    # Required permissions for code checkout + SARIF upload
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:

      # ----- Step 1: Download your code -----
      # Needed if building an image from a Dockerfile in the repo
      - name: Checkout code
        uses: actions/checkout@v4

      # ----- Step 2 (Optional): Build your Docker image -----
      # Only needed if scanning a locally-built image
      # Skip this step if scanning a public/registry image like nginx:latest
      - name: Build Docker Image
        run: |
          docker build -t fcs-test-image:latest -f Dockerfile.image-test .       # ‚¨ÖÔ∏è CHANGE: your Dockerfile path/tag

      # ----- Step 3: Run the CrowdStrike Image scan -----
      - name: Run FCS Image Assessment
        id: fcs
        uses: crowdstrike/fcs-action@v3.0.0
        with:
          falcon_client_id: ${{ vars.FALCON_CLIENT_ID }}
          falcon_region: ${{ vars.FALCON_REGION }}
          scan_type: image
          image: 'fcs-test-image:latest'
          minimum_severity: high
          report_formats: 'sarif'
          output_path: './image-scan-results.sarif'
          upload_results: true
        env:
          FALCON_CLIENT_SECRET: ${{ secrets.FALCON_CLIENT_SECRET }}

      # ----- Step 4: Save reports for download -----
      - name: Upload scan results as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fcs-image-scan-results
          path: ./image-scan-results.sarif
          if-no-files-found: warn

      # ----- Step 5: Push findings to GitHub Security tab -----
      - name: Upload SARIF to GitHub Code Scanning
        if: always() && steps.fcs.outputs.exit-code != 0
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ./image-scan-results.sarif

      # ----- Step 6: Enforce policy ‚Äî fail on ‚â•1 critical or ‚â•1 high -----
      - name: "Enforce Policy: critical=1, high=1"
        if: always()
        run: |
          EXIT_CODE="${{ steps.fcs.outputs.exit-code }}"

          echo "==========================================="
          echo "  FCS Image Assessment ‚Äî Policy Check"
          echo "==========================================="
          echo "  FCS CLI Exit Code : ${EXIT_CODE}"
          echo "  Policy            : Fail on ‚â•1 critical OR ‚â•1 high"
          echo "  Image Scanned     : fcs-test-image:latest"
          echo "==========================================="

          if [ -z "${EXIT_CODE}" ]; then
            echo ""
            echo "‚ö†Ô∏è  EXIT CODE IS EMPTY"
            echo "   The FCS action did not produce an exit-code output."
            echo "   Check the 'Run FCS Image Assessment' step logs."
            echo ""
            echo "‚ùå FAILING WORKFLOW ‚Äî unable to verify image safety."
            exit 1
          fi

          if [ "${EXIT_CODE}" != "0" ]; then
            echo ""
            echo "üî¥ VULNERABILITIES DETECTED"
            echo "   The image contains ‚â•1 critical or ‚â•1 high CVEs."
            echo ""
            echo "   Next steps:"
            echo "   1. Check the Security tab for detailed findings"
            echo "   2. Download the 'fcs-image-scan-results' artifact"
            echo "   3. Review in the Falcon Console"
            echo ""
            echo "‚ùå IMAGE SCAN FAILED ‚Äî Merge blocked."
            exit 1
          else
            echo ""
            echo "üü¢ NO HIGH/CRITICAL VULNERABILITIES FOUND"
            echo ""
            echo "‚úÖ IMAGE SCAN PASSED ‚Äî Safe to proceed."
          fi
